name: Docker Practice
on: push
jobs:
  caching:
    runs-on: ubuntu-latest
    name: Caching for Docker
    env:
      DOCKER_IMAGE: alpine
      DOCKER_TAG: 3.10
      DOCKER_IMAGE_TAG: $DOCKER_IMAGE:$DOCKER_TAG
      DOCKER_IMAGE_PATH: $DOCKER_IMAGE_PATH:$DOCKER_TAG
      DOCKER_CACHE_DIR: ~/docker
      DOCKER_FILENAME: $DOCKER_CACHE_DIR/$DOCKER_IMAGE.tar.gz
    steps:
      - uses: actions/checkout@v1   
      - name: Cache docker images
        id: docker-cache
        uses: actions/cache@v1
        with:
          path: $DOCKER_CACHE_DIR
          key: docker10
      - name: Save to cache if needed
        if: steps.docker-cache.outputs.cache-hit != 'true'
        run: |
          echo cache dir = $DOCKER_CACHE_DIR
          echo filename = $DOCKER_FILENAME
          mkdir -p $DOCKER_CACHE_DIR
          docker save --output $DOCKER_FILENAME $docker-image-path
          ls -l $docker-cache-dir
      - name: Load docker from cache
        run: |
          ls -l ${docker-cache-dir}
          docker load --input ${docker-filename}
      - run: docker run -t ${docker-image-tag} echo hello  
      - name: Local docker action uses cache
        uses: ./ #uses alpine in the action's Dockerfile
      # enable to demonstrate external actions eager building
      # - name: External docker action should use cache
      #   uses: AutoModality/action-hello-world-docker@v1 




